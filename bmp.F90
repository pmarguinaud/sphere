PROGRAM BMP 

INTEGER, PARAMETER :: JPRB = 8 

INTEGER*1 HEAD1 (54)
INTEGER*2 HEAD2 (54)
INTEGER*1, ALLOCATABLE :: IROW1 (:) 
REAL (KIND=JPRB), ALLOCATABLE :: ZROW1 (:, :)
INTEGER :: IOFF
CHARACTER (LEN=32) :: CLFILE

CALL GETARG (1, CLFILE)

OPEN (77, FILE=TRIM (CLFILE), FORM='UNFORMATTED', ACTION='READ', ACCESS='STREAM')
READ (77, POS=1) HEAD1

WHERE (HEAD1 >= 0)
  HEAD2 = HEAD1
ELSEWHERE
  HEAD2 = HEAD1 + 256 
ENDWHERE

IOFF = S4 (HEAD2 (11:14)) 
NCOL = S4 (HEAD2 (19:22))
NROW = S4 (HEAD2 (23:26))


print *, " IOFF = ", IOFF
print *, " NCOL = ", NCOL
print *, " NROW = ", NROW


ALLOCATE (IROW1 (3*NCOL), ZROW1 (NCOL, 3)) 

DO IROW = 1, NROW
  READ (77, POS=(IOFF+1+(IROW-1)*3*NCOL)) IROW1
  DO ICOL = 1, NCOL
    IR = IROW1 (3+(ICOL-1)*3); IF (IR < 0) IR = IR + 256 
    IG = IROW1 (2+(ICOL-1)*3); IF (IG < 0) IG = IG + 256 
    IB = IROW1 (1+(ICOL-1)*3); IF (IB < 0) IB = IB + 256 
    ZROW1 (ICOL, 1) = REAL (IR, JPRB) / 255._JPRB
    ZROW1 (ICOL, 2) = REAL (IG, JPRB) / 255._JPRB
    ZROW1 (ICOL, 3) = REAL (IB, JPRB) / 255._JPRB
  ENDDO
  WRITE (*, '(30F6.1)') ZROW1 (1:10, 1:3)
ENDDO

CLOSE (77)

CONTAINS

INTEGER FUNCTION S4 (H) 
INTEGER*2 :: H (4) 
S4 = H (1) + 256 * (H (2) + 256 * (H (3) + 256 * H (4)))
END FUNCTION

END

